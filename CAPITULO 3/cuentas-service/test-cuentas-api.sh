#!/bin/bash

# Script de pruebas para API de Gesti√≥n de Cuentas Bancarias
# Cap√≠tulo 3 - Quarkus Microservices Course

API_URL="http://localhost:8080/cuentas"
OUTPUT_FILE="resultados-pruebas-$(date +%Y%m%d-%H%M%S).txt"

echo "================================================"
echo "üè¶ PRUEBAS DE API - GESTI√ìN DE CUENTAS BANCARIAS"
echo "================================================"
echo ""
echo "üíæ Los resultados se guardar√°n en: $OUTPUT_FILE"
echo ""

# Funci√≥n para logging (muestra en pantalla Y guarda en archivo)
log_and_display() {
    echo "$1" | tee -a "$OUTPUT_FILE"
}

# Funci√≥n para hacer requests y formatear JSON
make_request() {
    local method=$1
    local endpoint=$2
    local data=$3
    
    # Crear archivo temporal para capturar response y headers
    local temp_file=$(mktemp)
    local http_code
    
    if [ -z "$data" ]; then
        # GET o DELETE sin body
        http_code=$(curl -s -w "%{http_code}" -o "$temp_file" -X "$method" "$endpoint")
    else
        # POST o PUT con body
        http_code=$(curl -s -w "%{http_code}" -o "$temp_file" -X "$method" "$endpoint" \
          -H "Content-Type: application/json" \
          -d "$data")
    fi
    
    # Mostrar c√≥digo HTTP
    echo "HTTP Status: $http_code" | tee -a "$OUTPUT_FILE"
    echo "" | tee -a "$OUTPUT_FILE"
    
    # Mostrar body si existe
    if [ -s "$temp_file" ]; then
        cat "$temp_file" | tee -a "$OUTPUT_FILE" | jq '.' 2>/dev/null || cat "$temp_file"
    else
        echo "(Sin contenido en el body)" | tee -a "$OUTPUT_FILE"
    fi
    
    # Limpiar archivo temporal
    rm -f "$temp_file"
}

# Funci√≥n para pausa interactiva
pause() {
    echo ""
    read -n 1 -s -r -p "‚ñ∂Ô∏è  Presiona cualquier tecla para continuar..."
    echo ""
    echo ""
}

log_and_display "================================================"
log_and_display "üè¶ PRUEBAS DE API - GESTI√ìN DE CUENTAS BANCARIAS"
log_and_display "Fecha: $(date)"
log_and_display "API URL: $API_URL"
log_and_display "================================================"
log_and_display ""

# Verificar que el servidor est√° corriendo
log_and_display "üîç Verificando conectividad con el servidor..."
if curl -s --max-time 3 "$API_URL" > /dev/null 2>&1; then
    log_and_display "‚úÖ Servidor respondiendo correctamente"
else
    log_and_display "‚ùå ERROR: No se puede conectar al servidor"
    log_and_display "   Aseg√∫rate de que el servidor est√° corriendo en $API_URL"
    log_and_display "   Ejecuta: ./mvnw quarkus:dev"
    exit 1
fi
log_and_display ""
pause

# ================================================
# SECCI√ìN 1: LISTAR TODAS LAS CUENTAS (GET)
# ================================================

log_and_display "================================================"
log_and_display "üìã TEST 1: LISTAR TODAS LAS CUENTAS (GET)"
log_and_display "================================================"
log_and_display "Endpoint: GET $API_URL"
log_and_display ""

make_request "GET" "$API_URL"

log_and_display ""
log_and_display "‚úÖ Esperado: Array con cuentas pre-cargadas"
log_and_display "   - Juan P√©rez (1000000001)"
log_and_display "   - Mar√≠a L√≥pez (1000000002)"
log_and_display "   - Carlos Ruiz (1000000003)"
log_and_display ""
pause

# ================================================
# SECCI√ìN 2: OBTENER UNA CUENTA ESPEC√çFICA (GET)
# ================================================

log_and_display "================================================"
log_and_display "üìã TEST 2: OBTENER CUENTA ESPEC√çFICA (GET)"
log_and_display "================================================"
log_and_display "Endpoint: GET $API_URL/1000000001"
log_and_display ""

make_request "GET" "$API_URL/1000000001"

log_and_display ""
log_and_display "‚úÖ Esperado: Cuenta de Juan P√©rez con saldo 5000.00"
log_and_display ""
pause

# ================================================
# SECCI√ìN 3: CREAR NUEVA CUENTA (POST)
# ================================================

log_and_display "================================================"
log_and_display "üìã TEST 3: CREAR NUEVA CUENTA (POST)"
log_and_display "================================================"
log_and_display "Endpoint: POST $API_URL"
log_and_display ""
log_and_display "Request Body:"
log_and_display '{
  "numero": "1000000004",
  "titular": "Ana Torres Mendoza",
  "saldo": 3500.00,
  "tipoCuenta": "AHORRO"
}'
log_and_display ""

make_request "POST" "$API_URL" '{
  "numero": "1000000004",
  "titular": "Ana Torres Mendoza",
  "saldo": 3500.00,
  "tipoCuenta": "AHORRO"
}'

log_and_display ""
log_and_display "‚úÖ Esperado: HTTP 201 Created con la cuenta creada"
log_and_display ""
pause

# ================================================
# SECCI√ìN 4: VERIFICAR CUENTA CREADA (GET)
# ================================================

log_and_display "================================================"
log_and_display "üìã TEST 4: VERIFICAR CUENTA CREADA (GET)"
log_and_display "================================================"
log_and_display "Endpoint: GET $API_URL/1000000004"
log_and_display ""

make_request "GET" "$API_URL/1000000004"

log_and_display ""
log_and_display "‚úÖ Esperado: Cuenta de Ana Torres con saldo 3500.00"
log_and_display ""
pause

# ================================================
# SECCI√ìN 5: ACTUALIZAR CUENTA (PUT)
# ================================================

log_and_display "================================================"
log_and_display "üìã TEST 5: ACTUALIZAR CUENTA (PUT)"
log_and_display "================================================"
log_and_display "Endpoint: PUT $API_URL/1000000004"
log_and_display ""
log_and_display "Request Body (cambio de saldo y tipo):"
log_and_display '{
  "numero": "1000000004",
  "titular": "Ana Torres Mendoza",
  "saldo": 7500.00,
  "tipoCuenta": "CORRIENTE"
}'
log_and_display ""

make_request "PUT" "$API_URL/1000000004" '{
  "numero": "1000000004",
  "titular": "Ana Torres Mendoza",
  "saldo": 7500.00,
  "tipoCuenta": "CORRIENTE"
}'

log_and_display ""
log_and_display "‚úÖ Esperado: HTTP 200 OK con cuenta actualizada"
log_and_display "   - Saldo: 7500.00 (antes: 3500.00)"
log_and_display "   - Tipo: CORRIENTE (antes: AHORRO)"
log_and_display ""
pause

# ================================================
# SECCI√ìN 6: VERIFICAR ACTUALIZACI√ìN (GET)
# ================================================

log_and_display "================================================"
log_and_display "üìã TEST 6: VERIFICAR ACTUALIZACI√ìN (GET)"
log_and_display "================================================"
log_and_display "Endpoint: GET $API_URL/1000000004"
log_and_display ""

make_request "GET" "$API_URL/1000000004"

log_and_display ""
log_and_display "‚úÖ Esperado: Saldo 7500.00 y tipo CORRIENTE"
log_and_display ""
pause

# ================================================
# SECCI√ìN 7: ELIMINAR CUENTA (DELETE)
# ================================================

log_and_display "================================================"
log_and_display "üìã TEST 7: ELIMINAR CUENTA (DELETE)"
log_and_display "================================================"
log_and_display "Endpoint: DELETE $API_URL/1000000003"
log_and_display "          (Eliminando cuenta de Carlos Ruiz)"
log_and_display ""

make_request "DELETE" "$API_URL/1000000003"

log_and_display ""
log_and_display "‚úÖ Esperado: HTTP 204 No Content (sin body)"
log_and_display ""
pause

# ================================================
# SECCI√ìN 8: VERIFICAR ELIMINACI√ìN (GET)
# ================================================

log_and_display "================================================"
log_and_display "üìã TEST 8: VERIFICAR ELIMINACI√ìN (GET)"
log_and_display "================================================"
log_and_display "Endpoint: GET $API_URL/1000000003"
log_and_display ""

make_request "GET" "$API_URL/1000000003"

log_and_display ""
log_and_display "‚úÖ Esperado: HTTP 404 Not Found - 'Cuenta no encontrada'"
log_and_display ""
pause

# ================================================
# SECCI√ìN 9: CUENTA INEXISTENTE (GET)
# ================================================

log_and_display "================================================"
log_and_display "üìã TEST 9: OBTENER CUENTA INEXISTENTE (GET)"
log_and_display "================================================"
log_and_display "Endpoint: GET $API_URL/9999999999"
log_and_display ""

make_request "GET" "$API_URL/9999999999"

log_and_display ""
log_and_display "‚úÖ Esperado: HTTP 404 Not Found"
log_and_display ""
pause

# ================================================
# SECCI√ìN 10: ACTUALIZAR CUENTA INEXISTENTE (PUT)
# ================================================

log_and_display "================================================"
log_and_display "üìã TEST 10: ACTUALIZAR CUENTA INEXISTENTE (PUT)"
log_and_display "================================================"
log_and_display "Endpoint: PUT $API_URL/9999999999"
log_and_display ""

make_request "PUT" "$API_URL/9999999999" '{
  "numero": "9999999999",
  "titular": "Inexistente",
  "saldo": 1000.00,
  "tipoCuenta": "AHORRO"
}'

log_and_display ""
log_and_display "‚úÖ Esperado: HTTP 404 Not Found"
log_and_display ""
pause

# ================================================
# SECCI√ìN 11: ELIMINAR CUENTA INEXISTENTE (DELETE)
# ================================================

log_and_display "================================================"
log_and_display "üìã TEST 11: ELIMINAR CUENTA INEXISTENTE (DELETE)"
log_and_display "================================================"
log_and_display "Endpoint: DELETE $API_URL/9999999999"
log_and_display ""

make_request "DELETE" "$API_URL/9999999999"

log_and_display ""
log_and_display "‚úÖ Esperado: HTTP 404 Not Found"
log_and_display ""
pause

# ================================================
# SECCI√ìN 12: LISTAR TODAS LAS CUENTAS FINAL (GET)
# ================================================

log_and_display "================================================"
log_and_display "üìã TEST 12: ESTADO FINAL - LISTAR TODAS (GET)"
log_and_display "================================================"
log_and_display "Endpoint: GET $API_URL"
log_and_display ""

RESPONSE=$(curl -s -X GET "$API_URL")
echo "$RESPONSE" | tee -a "$OUTPUT_FILE" | jq '.' 2>/dev/null || echo "$RESPONSE"

TOTAL=$(echo "$RESPONSE" | jq '. | length' 2>/dev/null || echo "?")
log_and_display ""
log_and_display "üìä Total de cuentas: $TOTAL"
log_and_display ""
log_and_display "‚úÖ Esperado: 3 cuentas"
log_and_display "   - Juan P√©rez (1000000001) - original"
log_and_display "   - Mar√≠a L√≥pez (1000000002) - original"
log_and_display "   - Ana Torres (1000000004) - nueva creada"
log_and_display "   ‚ùå Carlos Ruiz (1000000003) - eliminada"
log_and_display ""

# ================================================
# RESUMEN FINAL
# ================================================

log_and_display "================================================"
log_and_display "‚úÖ PRUEBAS COMPLETADAS"
log_and_display "================================================"
log_and_display ""
log_and_display "üìä RESUMEN DE OPERACIONES CRUD:"
log_and_display ""
log_and_display "   ‚úÖ READ (GET)    - Listar todas las cuentas"
log_and_display "   ‚úÖ READ (GET)    - Obtener cuenta espec√≠fica"
log_and_display "   ‚úÖ CREATE (POST) - Crear nueva cuenta"
log_and_display "   ‚úÖ UPDATE (PUT)  - Actualizar cuenta existente"
log_and_display "   ‚úÖ DELETE (DELETE) - Eliminar cuenta"
log_and_display ""
log_and_display "üìä CASOS DE ERROR PROBADOS:"
log_and_display ""
log_and_display "   ‚úÖ GET cuenta inexistente (404)"
log_and_display "   ‚úÖ PUT cuenta inexistente (404)"
log_and_display "   ‚úÖ DELETE cuenta inexistente (404)"
log_and_display ""
log_and_display "üí° NOTAS IMPORTANTES:"
log_and_display ""
log_and_display "   - Endpoint base: $API_URL"
log_and_display "   - N√∫meros de cuenta: 10 d√≠gitos"
log_and_display "   - Tipos v√°lidos: AHORRO, CORRIENTE"
log_and_display "   - Saldo: BigDecimal (precisi√≥n monetaria)"
log_and_display ""
log_and_display "üìÑ Resultados guardados en: $OUTPUT_FILE"
log_and_display ""
log_and_display "üîó RECURSOS √öTILES:"
log_and_display ""
log_and_display "   - Swagger UI: http://localhost:8080/q/swagger-ui"
log_and_display "   - Dev UI: http://localhost:8080/q/dev"
log_and_display "   - OpenAPI Spec: http://localhost:8080/q/openapi"
log_and_display ""

echo ""
echo "‚úÖ Archivo generado: $OUTPUT_FILE"
echo ""
echo "üí° TIP: Para ver el archivo formateado:"
echo "   cat $OUTPUT_FILE"
echo ""