# ═══════════════════════════════════════════════════════════════════════════
# PARTE 3: AUTENTICACIÓN CON OIDC (OPENID CONNECT + KEYCLOAK)
# ═══════════════════════════════════════════════════════════════════════════
# Esta configuración habilita OpenID Connect usando Keycloak como proveedor
# de identidad externo. Los tokens son emitidos y firmados por Keycloak.
#
# Para ejecutar esta parte:
#   ./mvnw quarkus:dev -Dquarkus.profile=parte3
#
# O en Windows (Git Bash):
#   ./mvnw quarkus:dev -Dquarkus.profile=parte3
#
# Prerequisitos:
#   - Keycloak corriendo en http://localhost:8180
#   - Realm "vaultcorp" configurado
#   - Client "vault-api" creado con client secret
#   - Usuarios con roles: customer y premium-customer
#
# Endpoints disponibles:
#   - GET  /api/external/secrets/profile       (requiere token OIDC - roles: customer o premium-customer)
#   - GET  /api/external/secrets/public        (requiere token OIDC - roles: customer o premium-customer)
#   - GET  /api/external/secrets/confidential  (requiere token OIDC - rol: premium-customer)
#
# Usuarios de prueba en Keycloak:
#   - client001 / pass001  (Carlos Gómez - rol: customer)
#   - client002 / pass002  (María López - rol: premium-customer)
#
# Flujo:
#   1. Obtener token desde Keycloak:
#      curl -X POST http://localhost:8180/realms/vaultcorp/protocol/openid-connect/token \
#        -H "Content-Type: application/x-www-form-urlencoded" \
#        -d "grant_type=password" \
#        -d "client_id=vault-api" \
#        -d "client_secret=<YOUR_CLIENT_SECRET>" \
#        -d "username=client001" \
#        -d "password=pass001"
#   2. Usar el access_token en header: Authorization: Bearer <token>
#   3. Acceder a endpoints protegidos
# ═══════════════════════════════════════════════════════════════════════════

# ───────────────────────────────────────────────────────────────────────────
# CONFIGURACIÓN OIDC (OpenID Connect)
# ───────────────────────────────────────────────────────────────────────────

# Habilitar OIDC
quarkus.oidc.enabled=true

# URL del servidor de autorización (Keycloak realm)
quarkus.oidc.auth-server-url=http://localhost:8180/realms/vaultcorp

# Client ID registrado en Keycloak
quarkus.oidc.client-id=vault-api

# Client Secret (debe coincidir con el configurado en Keycloak)
# ⚠️ IMPORTANTE: Reemplazar con tu client secret real de Keycloak
quarkus.oidc.credentials.secret=pnQqtvHgHHLWS1wAlaGsdDwBjKk3AgvO

# Tipo de aplicación: service (backend API)
quarkus.oidc.application-type=service

# Los roles vienen del token de acceso (claim realm_access.roles)
quarkus.oidc.roles.source=accesstoken

# Path del claim de roles en el token (Keycloak estructura por defecto)
quarkus.oidc.roles.role-claim-path=realm_access/roles

# Tolerancia para diferencias de timestamp (60 segundos)
quarkus.oidc.token.age=60

# Verificar el issuer del token
quarkus.oidc.token.issuer=http://localhost:8180/realms/vaultcorp

# ───────────────────────────────────────────────────────────────────────────
# DESHABILITAR OTRAS FORMAS DE AUTENTICACIÓN
# ───────────────────────────────────────────────────────────────────────────

# Deshabilitar Basic Auth
quarkus.http.auth.basic=false

# Deshabilitar usuarios embebidos
quarkus.security.users.embedded.enabled=false

# ───────────────────────────────────────────────────────────────────────────
# CONFIGURACIÓN ADICIONAL
# ───────────────────────────────────────────────────────────────────────────

# Logging para debugging (opcional - puedes comentar en producción)
quarkus.log.category."io.quarkus.oidc".level=DEBUG
quarkus.log.category."com.vaultcorp".level=INFO